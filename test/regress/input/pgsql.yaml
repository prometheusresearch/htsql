#
# Copyright (c) 2006-2011, Prometheus Research, LLC
# Authors: Clark C. Evans <cce@clarkevans.com>,
#          Kirill Simonov <xi@resolvent.net>
#

title: PostgreSQL regression tests
id: pgsql
output: test/regress/output/pgsql.yaml
tests:

- title: Remove any existing regression database
  id: drop-pgsql
  tests:
  - connect: &admin-connect
      engine: pgsql
      database: postgres
      username: ${PGSQL_ADMIN_USERNAME}
      password: ${PGSQL_ADMIN_PASSWORD}
      host: ${PGSQL_HOST}
      port: ${PGSQL_PORT}
    sql: !environ |
        DROP DATABASE IF EXISTS "${PGSQL_DATABASE}";
        DROP ROLE IF EXISTS "${PGSQL_USERNAME}";
    autocommit: true

- title: Deploy the regression database
  id: create-pgsql
  tests:
  - connect: *admin-connect
    sql: !environ |
        CREATE DATABASE "${PGSQL_DATABASE}" WITH ENCODING = 'UTF-8';
        CREATE ROLE "${PGSQL_USERNAME}" WITH LOGIN PASSWORD '${PGSQL_PASSWORD}';
        ALTER DATABASE "${PGSQL_DATABASE}" OWNER TO "${PGSQL_USERNAME}";
    autocommit: true
  - connect: &connect
      engine: pgsql
      database: ${PGSQL_DATABASE}
      username: ${PGSQL_USERNAME}
      password: ${PGSQL_PASSWORD}
      host: ${PGSQL_HOST}
      port: ${PGSQL_PORT}
    sql-include: test/regress/sql/regress-pgsql.sql

- title: Run the test collection
  id: test-pgsql
  tests:
  - define: pgsql
  - db: *connect
  # The Regression Schema
  - include: test/regress/input/schema.yaml
  # Examples from the Tutorial
  - include: test/regress/input/tutorial.yaml
  # Standard Data Types, Functions, and Operations
  - include: test/regress/input/library.yaml
  # Edge Cases of HTSQL-to-SQL Translation
  - include: test/regress/input/translation.yaml
  # Formatting Output Data
  - include: test/regress/input/format.yaml

